module Licensing.Scripts.TestLoanRepaymentToken where

import Daml.Script

import DA.Assert
import DA.Time
import Splice.Api.Token.MetadataV1 as Api.Token.MetadataV1
import Splice.Api.Token.AllocationV1
import Splice.Api.Token.HoldingV1
import Splice.Api.Token.AllocationRequestV1
import Splice.Api.Token.AllocationInstructionV1

import Splice.Testing.Registries.AmuletRegistry qualified as AmuletRegistry
import Splice.Testing.TokenStandard.RegistryApi qualified as RegistryApi
import Splice.Testing.TokenStandard.WalletClient qualified as WalletClient
import Splice.Testing.Utils

import Licensing.Scripts.TestUtil (fetchAllocationsForRenewal)

import Loan.Loan
import Loan.LoanTypes (LoanStatus(Active))
import Loan.CreditProfile
import Loan.LoanRepaymentRequest

-- | Test token-based loan repayment using AllocationRequest/Allocation.
testLoanRepaymentToken : Script ()
testLoanRepaymentToken = script do
  registry <- AmuletRegistry.initialize AmuletRegistry.defaultAmuletRegistryConfig

  lender <- allocatePartyExact "lender"
  borrower <- allocatePartyExact "borrower"

  -- fund borrower for repayment
  AmuletRegistry.tapLockedAndUnlockedFunds registry borrower 1000.0

  now <- getTime
  creditProfileCid <- submit borrower $ createCmd CreditProfile with
    borrower = borrower
    creditScore = initialCreditScore
    totalLoans = 0
    successfulLoans = 0
    defaultedLoans = 0
    createdAt = now

  -- create an active loan with both signatories
  loanCid <- submitMulti [lender, borrower] [] $ createCmd Loan with
    lender = lender
    borrower = borrower
    principal = 100.0
    interestRate = 5.0
    dueDate = now `addRelTime` days 30
    creditProfileId = creditProfileCid
    status = Active

  let instrumentId = InstrumentId { admin = registry.dso, id = "Amulet" }

  -- borrower requests repayment
  repaymentRequestCid <- submit borrower $
    exerciseCmd loanCid Loan_RequestRepayment with
      requestId = "loan-repayment-1"
      instrumentId = instrumentId
      prepareUntil = now `addRelTime` hours 1
      settleBefore = now `addRelTime` hours 2
      description = "Loan repayment token flow"

  -- borrower allocates via wallet
  [borrowerAlloc] <- WalletClient.listRequestedAllocations borrower instrumentId
  borrowerAlloc.transferLeg.amount === 105.0
  borrowerHoldingCids <- WalletClient.listHoldingCids borrower instrumentId

  enrichedChoice <- RegistryApi.getAllocationFactory registry AllocationFactory_Allocate with
    expectedAdmin = registry.dso
    allocation = borrowerAlloc
    requestedAt = now
    inputHoldingCids = borrowerHoldingCids
    extraArgs = emptyExtraArgs

  submitWithDisclosures' borrower enrichedChoice.disclosures $
    exerciseCmd enrichedChoice.factoryCid enrichedChoice.arg

  -- lender completes repayment
  Some repaymentRequest <- queryContractId lender repaymentRequestCid
  let settlementRef = (view $ toInterface @AllocationRequest repaymentRequest).settlement.settlementRef
  (allocCid, _) <- fetchAllocationsForRenewal lender settlementRef

  context <- RegistryApi.getAllocation_TransferContext registry allocCid emptyMetadata
  -- Complete repayment (token transfer)
  submitWithDisclosures' lender context.disclosures $
    exerciseCmd repaymentRequestCid LoanRepaymentRequest_CompleteRepayment with
      allocationCid = allocCid
      extraArgs = ExtraArgs with
        context = context.choiceContext
        meta = emptyMetadata
  -- Complete loan (separate transaction; borrower must co-authorize for CreditProfile update)
  submitMulti [lender, borrower] [] $ exerciseCmd loanCid Loan_CompleteRepaymentReceived

  -- verify loan archived and credit profile updated
  loansForLender <- query @Loan lender
  length loansForLender === 0

  [profile] <- query @CreditProfile borrower
  profile._2.successfulLoans === 1

